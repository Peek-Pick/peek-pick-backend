import{w as F}from "./with-props-JNWkkrjn.js";import{a,q as M,p as S}from "./chunk-D4RADZKF-DdSvw7tX.js";import{j as e}from "./jsx-runtime-D_zvdyIk.js";import{G as P}from "./iconBase-CtWej6xm.js";import{i as N}from "./axiosInstance-CCaw23o5.js";import{g as R}from "./myPageAPI-BH0myYQf.js";import{m as w}from "./proxy-B6a-3iLd.js";import"./index-xsH4HHeE.js";function I(t){return P({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"line",attr:{x1:"22",y1:"2",x2:"11",y2:"13"},child:[]},{tag:"polygon",attr:{points:"22 2 15 22 11 13 2 9 22 2"},child:[]}]})(t)}const T=async t=>{const n=await N.post("chatbot/ask",t,{headers:{"Content-Type":"text/plain"},responseType:"text"});try{return JSON.parse(n.data)}catch{return n.data}},L=async()=>{try{const t=await N.post("chatbot/reset",null,{withCredentials:!0});return console.log("✅ 메모리 생성"),t.data}catch(t){console.error("❌ resetMemory 요청 실패:",t)}};function E({handleSendMessage:t}){const[n,c]=a.useState("User");a.useEffect(()=>{(async()=>{try{const i=await R();c(i.nickname)}catch(i){console.error("닉네임 불러오기 실패:",i)}})()},[]);const u=[{title:"Barcode & Product",subtitle:"Check product info and Request registration",items:["Check product info by barcode","Request product registration","Troubleshoot barcode recognition"]},{title:"Reviews & Points",subtitle:"Point accumulation and Review management",items:["How to write a review","Earn points with reviews","Report a review"]},{title:"Convenience Features",subtitle:"Chatbot, Map, Account management",items:["How to use the AI chatbot","Find nearby convenience stores","Sign up and withdraw account"]}];return e.jsx(e.Fragment,{children:e.jsxs("section",{className:"space-y-1",children:[e.jsxs(w.div,{initial:{opacity:0,y:40},animate:{opacity:1,y:0},transition:{duration:.6,ease:"easeOut"},className:"flex justify-between items-start px-6 pt-10 pb-6",children:[e.jsxs("div",{className:"leading-loose text-xl",children:[e.jsxs("p",{children:["Hello, ",e.jsx("span",{className:"text-yellow-600 font-bold",children:n}),"!"]}),e.jsx("p",{className:"text-base font-semibold",children:"I am Peek&Pick chatbot."}),e.jsx("p",{className:"text-sm text-gray-600",children:"How can I assist you today?"})]}),e.jsx(w.img,{src:"/mascot.png",alt:"챗봇 마스코트",className:"w-32 h-32 flex-shrink-0",initial:{opacity:0,scale:.3,y:-100},animate:{opacity:1,scale:1,y:0},transition:{type:"spring",stiffness:500,damping:15,delay:.8}})]}),e.jsx(w.div,{className:"flex overflow-x-auto space-x-4 snap-x snap-mandatory scroll-smooth pb-2 px-4",initial:{opacity:0,y:40},animate:{opacity:1,y:0},transition:{duration:.6,ease:"easeOut",delay:.3},children:u.map((o, i)=>e.jsxs("div",{className:"min-w-[75%] sm:min-w-[55%] bg-white rounded-2xl shadow p-5 snap-center",children:[e.jsx("h4",{className:"font-bold text-lg mb-1 underline decoration-yellow-400",children:o.title}),e.jsx("p",{className:"text-sm mb-4 text-gray-600",children:o.subtitle}),o.items.map(m=>e.jsx("button",{onClick:()=>{t(m).then()},className:"w-full border border-yellow-300 rounded-lg py-2 mb-2 text-sm hover:bg-yellow-50",children:m},m))]},i))})]})})}function $({product:t}){return console.log(t.imgUrl),e.jsxs("div",{className:"bg-white p-6 rounded-2xl shadow-lg text-center max-w-md mx-auto border border-gray-100",children:[e.jsx("h2",{className:"text-md font-semibold mb-2",children:t.productName}),e.jsx("img",{src:`https://myapp.peek-pick.click${t.imgUrl}`,alt:t.productName,className:"w-[160px] mx-auto rounded-lg shadow-sm mb-4"}),e.jsx("p",{className:"text-sm text-gray-800 mb-5 leading-relaxed",children:t.reason}),e.jsx(M,{to:`/products/${t.barcode}`,className:"inline-block px-5 py-2 rounded-full border border-gray-300 bg-white text-gray-800 text-sm hover:bg-gray-100 hover:shadow-md transition-all duration-200 font-medium",children:"View Prodcut"})]})}function z(){const[t,n]=a.useState([]),[c,u]=a.useState(""),[o,i]=a.useState(""),[m,f]=a.useState(!1),[x,j]=a.useState(!1),p=a.useRef(null);a.useEffect(()=>{p.current&&(p.current.scrollTop=p.current.scrollHeight)},[t,m,o]),a.useEffect(()=>{if(m){const s=t[t.length-1];if(typeof s.content=="string"){const d=s.content;let r="";const l=setInterval(()=>{r.length<d.length?(r+=s.content[r.length],i(r)):(clearInterval(l),f(!1))},30);return()=>clearInterval(l)}else i(""),f(!1)}},[m,t]),a.useEffect(()=>{L(),console.log("ChatPage 마운트됨")},[]);const v= s=>/^[a-zA-Z\s.,!?']+$/.test(s)?"en":/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(s)?"ko":/[ぁ-んァ-ン]/.test(s)?"ja":/[一-龥]/.test(s)?"zh":"en",b=async s=>{var r;const d=(s??c).trim();if(d){n(l=>[...l,{content:d,isFromChatbot:!1}]),u(""),j(!0);try{const l=await T(d),h=l||"답변을 불러올 수 없습니다.";typeof h=="string"||h===null||Object.keys(h).length===0?n(g=>[...g,{content:h,isFromChatbot:!0}]):n(g=>[...g,{content:e.jsx($,{product:l}),isFromChatbot:!0}]),i(""),f(!0)}catch(l){console.error("챗봇 오류:",l);const h=((r=t.filter(y=>!y.isFromChatbot).pop())==null?void 0:r.content)??"",k=v(typeof h=="string"?h:""),C={en:"💡 The system is busy now. Please try again in a moment!",ko:"💡 지금 요청이 몰려 잠시 대답이 어려워요. 잠시 후 다시 시도해 주세요!",ja:"💡 現在リクエストが集中しており、少し後で再試行してください！",zh:"💡 当前请求过多，请稍后再试！"}[k];n(y=>[...y,{content:C,isFromChatbot:!0}])}finally{j(!1)}}};return e.jsxs(e.Fragment,{children:[t.length===0&&e.jsx(E,{handleSendMessage:b}),e.jsxs("main",{className:"w-full flex flex-col overflow-y-auto p-4 scrollbar-thin scrollbar-thumb-blue-400 scrollbar-track-blue-100",ref:p,style:{height:"calc(86vh)"},children:[t.map((s, d)=>{const r=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:`max-w-[85%] ${s.isFromChatbot?"self-start":"self-end"}`,children:[e.jsx("div",{className:"mb-2 px-1 flex items-center space-x-3 text-sm text-gray-500",children:s.isFromChatbot?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:"/mascot.png",alt:"AI",className:"w-9 h-9 rounded-full border"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"Kim Assistant"}),e.jsx("span",{children:r})]}):e.jsx("span",{className:"ml-auto text-right",children:r})}),e.jsx("div",{className:`flex items-start px-4 py-3 rounded-3xl break-words whitespace-pre-wrap
                                    ${s.isFromChatbot?"bg-white text-gray-600 rounded-tl-none shadow-md":"bg-zinc-800 text-white rounded-tr-none shadow-md"}
                                `,style:{wordBreak:"break-word",fontSize:"1rem"},children:e.jsx("span",{children:s.isFromChatbot&&m&&d===t.length-1?o:s.content})})]},d)}),x&&e.jsx("div",{className:"max-w-[85%] self-start bg-white text-gray-600 inline-flex items-center px-5 py-3 rounded-2xl rounded-tl-none shadow-lg animate-pulse",children:e.jsx("span",{style:{fontSize:"1rem"},children:"Loading..."})})]}),e.jsxs("footer",{className:"h-[8vh] fixed bottom-0 left-0 w-full bg-white border-t border-gray-300 px-4 py-4 flex items-center",children:[e.jsx("input",{className:"flex-1 border border-gray-300 rounded-full px-5 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-300",type:"text",placeholder:"Please enter your question.",value:c,onChange:s=>{u(s.target.value),s.target.style.height="auto",s.target.style.height=`${Math.min(s.target.scrollHeight,192)}px`},onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),b().then(()=>{}))},disabled:x,style:{minWidth:"0"},"aria-label":"채팅 입력창"}),e.jsx("button",{onClick:()=>b(),disabled:x||c.trim()==="",className:`ml-4 transition-colors ${x||c.trim()===""?"text-gray-400 cursor-not-allowed":"text-amber-600 hover:text-amber-800"}`,"aria-label":"메시지 전송",children:e.jsx(I,{className:"w-7 h-7"})})]})]})}const V=F(function(){const n=S(),[c,u]=a.useState(!0);return a.useEffect(()=>{const o=setTimeout(()=>u(!1),1500);return()=>clearTimeout(o)},[]),c?e.jsx("div",{className:"flex w-full items-center bg-white justify-center h-screen",children:e.jsx("img",{src:"/loading/chatbotLoading.gif",alt:"Loading...",className:"w-32 h-32 animate-spin"})}):e.jsxs("div",{className:"flex flex-col h-screen w-full bg-amber-50",children:[e.jsxs("header",{className:"flex items-center justify-between bg-emerald-500 text-white py-3 px-5 font-semibold text-xl shadow-md",children:[e.jsx("div",{children:"Ai ChatBot"}),e.jsx("button",{onClick:()=>n(-1),className:"text-base text-white text-semibold border-2 border-white px-3 py-1 rounded-2xl",children:"Exit"})]}),e.jsx(z,{})]})});export{V as default};
