import{w as P}from "./with-props-JNWkkrjn.js";import{p as E,a as d,w as T}from "./chunk-D4RADZKF-DdSvw7tX.js";import{j as e}from "./jsx-runtime-D_zvdyIk.js";import{u as w}from "./useQuery-CxabGwVz.js";import{u as I}from "./QueryClientProvider--V26__jT.js";import{u as R}from "./useMutation-iBKtBQ4J.js";import{a as M,t as A,b as q,c as F}from "./reviewAPI-zRekXALF.js";import{u as B}from "./useReviewReport-CWkDotFm.js";import{R as $}from "./rating-s5hnHQfB.js";import{u as K,F as Q}from "./floatingHearts-Bwxc8ijh.js";import{T as H,H as D,t as U,A as O,a as _}from "./averageRatingSection-CBjjqmYw.js";import{I as z}from "./ImageModalComponent-Cw5E8d8F.js";import{u as k}from "./useTranslation-DnilsLqi.js";import{t as Y,g as V}from "./productsAPI-NkJZ08PW.js";import{B as W,F as G}from "./FloatingActionButtons-3zuONfQ9.js";import"./iconify-uWM87A7v.js";import{P as J}from "./productLoading-CtBxAkDp.js";import"./useBaseQuery-BTSvK_Q6.js";import"./removable-CGh8wCEh.js";import"./query-CjmfnAM3.js";import"./mutation-CruqbX-z.js";import"./axiosInstance-CCaw23o5.js";import"./index-xsH4HHeE.js";import"./sweetalert2.esm.all-9Qm2jZ7z.js";/* empty css                         */import"./index-Druiat5n.js";import"./proxy-B6a-3iLd.js";import"./i18nInstance-CHFDjdcJ.js";import"./createLucideIcon-Cyt6UY_L.js";function X({barcode:t,reviewNum:n}){const{t:i,i18n:x}=k(),h=x.language,s=E(),[o,c]=d.useState(null);d.useEffect(()=>{M(t).then(g=>{c(Number(g.data))})},[t]);const{data:u,isLoading:y,isError:j}=w({queryKey:["previews",o],queryFn:()=>q(o,h),enabled:!!o});return y?e.jsx("p",{className:"text-center p-4 text-base sm:text-lg",children:i("reviewLoading")}):j?e.jsx("p",{className:"text-center p-4 text-red-500 text-base sm:text-lg",children:i("reviewLoadError")}):!u||u.length===0?e.jsx("p",{className:"text-center p-4 text-gray-500 text-base sm:text-lg",children:i("reviewEmptyError")}):e.jsx("div",{children:e.jsx("section",{className:"relative",children:e.jsx("div",{className:"w-full max-w-7xl md:px-5 lg-6 mx-auto",children:e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center border-t border-b border-gray-200 py-4 mb-2",children:[e.jsxs("span",{children:[i("totalReview"),": ",e.jsx("span",{className:"text-red-500 font-semibold",children:n})]}),e.jsxs("button",{onClick:()=>s(`/reviews/product/${t}`),className:"text-sm sm:text-sm text-gray-500 hover:text-gray-700 hover:font-semibold transition",children:[i("viewAll")," >"]})]}),u.map(g=>e.jsx(Z,{review:g,productId:o},g.reviewId))]})})})})}function Z({review:t,productId:n}){var C,L;const{t:i}=k(),x=I(),{openReportModal:h}=B(t.reviewId),[s,o]=d.useState(!1),[c,u]=d.useState(!1),[y,j]=d.useState(null),[g,r]=d.useState(!1),[p,l]=d.useState(null),f=R({mutationFn: a=>A(a),onSuccess:()=>{x.invalidateQueries({queryKey:["previews",n]}).then()},onError: a=>{console.error("toggleLikeMutation failed: ",a)}}),{handleLikeClick:m,containerRef:b,hearts:v}=K(f.mutate,t),S=async()=>{if(c){u(!1);return}try{r(!0);const a=await U(t.reviewId);await new Promise(N=>setTimeout(N,1200)),j(a.data),u(!0)}catch(a){console.error("ë²ˆì—­ ì‹¤íŒ¨",a)}finally{r(!1)}};return e.jsxs("div",{className:"relative",ref:b,children:[e.jsxs("div",{className:`bg-white rounded-xl p-5 shadow-md mb-2 transition-opacity duration-200 ${t.isHidden&&!s?"opacity-50":"opacity-100"}`,children:[e.jsx("div",{className:"flex sm:items-center flex-col min-[400px]:flex-row justify-between gap-5 mb-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:`https://myapp.peek-pick.click/users/${t.profileImageUrl}`,alt:"profile image",className:"w-14 h-14 rounded-full object-cover"}),e.jsx("h6",{className:"font-semibold text-md leading-8 text-gray-600",children:t.nickname??"User"})]}),e.jsxs("button",{onClick:S,disabled:g,className:"flex items-center gap-1 text-xs px-3 py-1.5 rounded-full transition-all shadow-sm bg-blue-50 text-blue-500 hover:bg-blue-100",children:[e.jsx("span",{children:c?"â†©":"ðŸŒ"}),e.jsx("span",{children:i(c?"translateOriginalButton":"translateButton")})]})]})}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:Array.from({length:5}).map((a, N)=>e.jsx($,{filled:N<t.score},N))}),e.jsx("p",{className:"font-normal text-sm sm:text-sm text-gray-400",children:new Date(t.regDate).toLocaleDateString()})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("p",{className:`text-sm text-gray-700 whitespace-pre-line transition-opacity duration-300 ${g?"opacity-20 blur-[1px]":"opacity-100"}`,children:c?y:t.comment}),g&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10",children:e.jsx(H,{})})]}),((C=t.images)==null?void 0:C.length)>0&&e.jsx("div",{className:"flex flex-nowrap space-x-2 mb-4 overflow-x-auto no-scrollbar",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:t.images.map(a=>e.jsx("img",{src:`https://myapp.peek-pick.click/reviews/s_${a.imgUrl}`,alt:"Review Image",onClick:()=>l(`https://myapp.peek-pick.click/reviews/${a.imgUrl}`),className:"w-25 h-25 sm:w-25 sm:h-25 rounded-lg object-cover flex-shrink-0 border-1 border-gray-300 "},a.imgId))}),p&&e.jsx(z,{src:p,onClose:()=>l(null)}),((L=t.tagList)==null?void 0:L.length)>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:t.tagList.map(a=>e.jsxs("span",{className:"bg-emerald-50 text-emerald-500 border border-emerald-200 text-sm sm:text-sm px-3 py-1 rounded-full",children:["#",i(`tags.${a.tagName}`)]},a.tagId))}),e.jsxs("div",{className:"flex justify-between items-center text-sm sm:text-base mt-3",children:[e.jsxs("button",{onClick:m,disabled:f.isPending,className:`flex items-center gap-1 px-2 py-1 rounded-full border font-medium text-sm sm:text-sm
                        ${t.isLiked?"bg-red-50 text-red-500 border-red-200":"bg-gray-100 text-gray-500 border-gray-200"} 
                        hover:shadow-sm transition-colors duration-200`,children:[t.isLiked?"â¤ï¸":"ðŸ¤"," ",i("likeReview")," ",t.recommendCnt]}),e.jsx("button",{onClick:h,className:"text-red-500 hover:text-red-600 transition text-sm sm:text-sm duration-200",children:i("reportReview")}),v.map(a=>e.jsx(Q,{x:a.x,y:a.y},a.id))]})]}),t.isHidden&&!s&&e.jsx(D,{onReveal:()=>o(!0)})]})}function ee({product:t,onClose:n}){return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/30 flex items-center justify-center ",children:e.jsxs("div",{className:"flex flex-col bg-white rounded-2xl py-4 px-3 h-[500px] overflow-y-auto mx-8",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h4",{className:"text-base font-bold",children:t.name}),e.jsx("button",{onClick:n,className:"text-gray-500 hover:text-black",children:"âœ•"})]}),e.jsxs("div",{className:"flex-grow overflow-y-auto px-3 py-4",children:[e.jsxs("div",{className:"block mb-4",children:[e.jsx("h3",{className:"text-gray-900 font-semibold mb-2",children:"Product Info"}),e.jsx("p",{className:"text-gray-600 text-sm",children:t.description??"-"})]}),e.jsxs("div",{className:"block mb-4",children:[e.jsx("h3",{className:"text-sm text-gray-900 font-semibold mb-2",children:"Category"}),e.jsx("p",{className:"text-gray-600 text-sm",children:t.category??"-"})]}),e.jsxs("div",{className:"block mb-4",children:[e.jsx("h3",{className:"text-sm text-gray-900 font-semibold mb-2",children:"Volume"}),e.jsx("p",{className:"text-gray-600 text-sm",children:t.volume??"-"})]}),e.jsxs("div",{className:"block mb-4",children:[e.jsx("h3",{className:"text-sm text-gray-900 font-semibold mb-2",children:"Ingredients"}),e.jsx("p",{className:"text-gray-600 text-sm",children:t.ingredients??"-"})]}),e.jsxs("div",{className:"block mb-4",children:[e.jsx("h3",{className:"text-sm text-gray-900 font-semibold mb-2",children:"Allergens"}),e.jsx("p",{className:"text-gray-600 text-sm",children:t.allergens??"-"})]}),e.jsxs("div",{className:"block mb-4",children:[e.jsx("h3",{className:"text-sm text-gray-900 font-semibold mb-2",children:"Nutrition"}),e.jsx("p",{className:"text-gray-600 text-sm",children:t.nutrition??"-"})]})]}),e.jsx("div",{className:"p-4 border-t flex justify-end",children:e.jsx("button",{onClick:n,className:" flex items-center gap-1 px-2 py-1 rounded-full border font-medium text-xs sm:text-xs bg-gray-100 text-gray-500 border-gray-200",children:"Cancel"})})]})})}function te({product:t,isLoading:n,isError:i}){if(n)return e.jsx(J,{});if(i||!t)return e.jsx("p",{className:"text-center p-4 text-red-500 text-base sm:text-lg",children:"Failed to load product information."});if(t.isDelete)return e.jsx("div",{className:"p-4 text-center text-gray-500",children:"This product has been deleted."});const x=I(),[h,s]=d.useState(t.isLiked),[o,c]=d.useState(t.likeCount??0),[u,y]=d.useState(!1);d.useEffect(()=>{const r=x.getQueryCache().findAll({predicate:p=>["recommended","productsRanking","searchProducts"].includes(String(p.queryKey[0]))}).flatMap(p=>{const l=x.getQueryData(p.queryKey);return l&&typeof l=="object"&&"pages"in l&&Array.isArray(l.pages)?l.pages.flatMap(f=>f.content):[]}).find(p=>p.barcode===t.barcode);r&&(s(r.isLiked),c(r.likeCount??0))},[]);const j=R({mutationFn:()=>Y(t.barcode),onMutate:async()=>{const r=!h,p=r?o+1:o-1;s(r),c(p);const l=x.getQueryCache().findAll({predicate:f=>["recommended","productsRanking","searchProducts"].includes(String(f.queryKey[0]))});return l.forEach(({queryKey:f})=>{x.setQueryData(f,m=>!m||!Array.isArray(m.pages)?m:{...m,pages:m.pages.map(b=>({...b,content:b.content.map(v=>v.barcode===t.barcode?{...v,isLiked:r,likeCount:(v.likeCount??0)+(r?1:-1)}:v)})),pageParams:m.pageParams})}),{newLiked:r,previousCaches:l}},onError:(r,p,l)=>{const{newLiked:f,previousCaches:m}=l??{};s(!f),c(b=>f?b-1:b+1),m==null||m.forEach(({queryKey:b})=>{x.invalidateQueries({queryKey:b})}),console.error("Failed to toggle like",r)}}),g=()=>{j.mutate()};return e.jsx("div",{children:e.jsx("section",{className:"relative",children:e.jsx("div",{className:"w-full max-w-7xl md:px-5 lg-6 mx-auto",children:e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"flex flex-row flex-nowrap items-center bg-white rounded-2xl shadow-sm transition-all duration-500 w-full overflow-hidden mb-7",children:[e.jsx("div",{className:"w-38 h-38 flex-shrink-0 overflow-hidden rounded-l-2xl",children:e.jsx("img",{src:`https://myapp.peek-pick.click${t.imgUrl}`,alt:"Product image",className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"p-4 w-full",children:[e.jsx("h4",{className:"text-base font-semibold text-gray-900 mb-2 capitalize transition-all duration-500 w-full ",children:t.name}),e.jsx("p",{className:"text-sm font-normal text-gray-500 transition-all duration-500 leading-5 mb-2 w-full",children:t.description??"-"}),e.jsxs("div",{className:"flex justify-between items-center text-sm sm:text-base mt-3",children:[e.jsxs("button",{onClick:g,className:`flex items-center gap-1 px-2 py-1 rounded-full border font-medium text-xs sm:text-xs
                                            ${h?"bg-red-50 text-red-500 border-red-200":"bg-gray-100 text-gray-500 border-gray-200"} 
                                            hover:shadow-sm transition-colors duration-200`,children:[h?"â¤ï¸":"ðŸ¤"," Like ",o]}),e.jsx("button",{onClick:()=>y(!0),className:"text-red-500 hover:text-red-600 transition text-sm sm:text-sm duration-200",children:"Read More"})]}),u&&e.jsx(ee,{product:t,onClose:()=>y(!1)})]})]})})})})})}const se="rankingPageScrollY",Te=P(function(){const{barcode:n}=T(),{t:i,i18n:x}=k(),h=x.language;d.useLayoutEffect(()=>{var r;((r=performance.getEntriesByType("navigation").at(-1))==null?void 0:r.type)==="reload"&&sessionStorage.removeItem(se)},[]);const{data:s,isLoading:o,isError:c}=w({queryKey:["productDetail",n],queryFn:()=>V(n,h),enabled:!!n,staleTime:5*60*1e3}),{data:u,isLoading:y,isError:j}=w({queryKey:["reviewSummary",s==null?void 0:s.productId],queryFn:()=>F(s==null?void 0:s.productId,h),enabled:(s==null?void 0:s.productId)!==null&&(s==null?void 0:s.productId)!==void 0});return e.jsxs(e.Fragment,{children:[e.jsx(te,{product:s,isLoading:o,isError:c}),s&&e.jsx(O,{score:s.score??5,reviewCount:s.reviewCount}),u&&e.jsx(_,{aiReview:u}),s&&e.jsx(X,{barcode:n,reviewNum:s.reviewCount}),e.jsx(W,{}),e.jsx(G,{})]})});export{Te as default};
